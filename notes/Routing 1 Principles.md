# Routing 1: Principles


## 一、定义路由问题
该模块回答“为何需要路由”“如何建模网络”“路由难在哪”“有哪些路由协议”四大核心问题，为理解路由机制奠定基础。

### 1. 为何需要路由

路由的本质是解决“多设备高效通信”的拓扑设计问题，通过对比三种拓扑的优劣，凸显路由器的必要性：
- **全连接拓扑**  
  原理：每对设备间直接连一条链路（如 5 台设备需 10 条链路）。  
  优势：设备间有专属高带宽链路。  
  劣势：**扩展性极差**——新增1台设备需新增 N 条链路（N 为现有设备数），无法支撑大规模网络。

- **单链路拓扑**  
  原理：所有设备共享一条链路（如 5 台设备连在同一条线上）。  
  优势：扩展性优于全连接（新增设备仅需接入链路）。  
  劣势：**带宽严重不足**——所有设备争抢同一链路资源，卡顿频繁。

- **引入路由器的拓扑**  
  原理：用路由器（中间转发设备）连接设备，形成分层网络。  
  核心优势：  
  1. 减少链路数：无需设备间两两直连，链路数量大幅降低；  
  2. 提升容量：链路不共享，各设备组可独立使用带宽；  
  3. 故障冗余：某条链路故障时，可通过其他路径转发数据（如 R1-R2 链路断了，可走 R1-R3-R2）。  
  关键结论：引入路由器后，需通过**路由协议**计算设备间的通信路径，这就是路由的核心需求。

### 2. 网络建模

将复杂网络抽象为可分析的模型，明确核心组件的角色与结构：
- **设备分类：路由器 vs 主机**  
  | 类型       | 核心功能                  | 例子                          | 关键特点                  |
  |------------|---------------------------|-------------------------------|---------------------------|
  | 主机（Host）| 收发数据包（端到端通信）  | 个人电脑、手机                | 不转发中间数据包          |
  | 路由器（Router）| 转发中间数据包            | 家用路由器、数据中心路由器    | 不主动收发自身的应用数据包|

- **拓扑建模：图（Graph）**  
  抽象规则：  
  
  1. 节点（Node）：代表主机或路由器（用不同符号区分，如主机用“A/B”，路由器用“R1/R2”）；  
  2. 边（Edge）：代表链路（每条边连接 2 个节点，暂不考虑多节点共享链路）；  
  3. 标识：每个设备有唯一标签（后续会深入“地址”概念）。
  
- **数据单元：数据包（Packet）**  
  结构分为两部分：  
  
  1. 头部（Header）：含**源地址**（数据包发送方）和**目的地址**（数据包接收方），是路由决策的核心依据；  
  2. 载荷（Payload）：应用数据（如网页内容、图片），路由仅负责转发，不关心载荷内容。

### 3. 路由的难点

路由需应对网络的动态性与分布式特性，核心难点有三：
1. **拓扑动态变化**  
   网络并非固定不变：主机随时进出（如手机连/断 WiFi）、链路随时故障/新增（如网线被拔、新增路由器），路由协议需“实时适应”这些变化，保证通信不中断。

2. **路由器无全局视图**  
   路由器无法“看到”整个网络，仅能感知直接相连的邻居设备（如 R2 只能知道 R1、R3、R4，不知道 R5）。路由决策需通过**分布式协调**实现——路由器之间交换信息，逐步构建全网路径，而非依赖“中央大脑”。

3. **链路“尽力而为”**  
   网络三层（网络层）的链路不保证数据包 100% 送达，可能因拥堵、故障丢包，路由协议需在“丢包风险”下仍尽可能保障路径有效。

### 4. 路由协议类型

路由协议按“作用范围”和“运作方式”分类，核心是区分“域内”与“域间”：
- **按作用范围：域内（Intra-domain）vs 域间（Inter-domain）**  
  
  | 类型         | 作用场景                  | 别称          | 核心特点                          | 例子                  |
  |--------------|---------------------------|---------------|-----------------------------------|-----------------------|
  | 域内路由     | 单个网络内部（如校园网）  | IGP（内部网关协议） | 每个网络可自主选择协议，适配自身需求（如规模、带宽） | OSPF、RIP             |
  | 域间路由     | 多个网络之间（如校园网↔电信网） | EGP（外部网关协议） | 所有网络需统一协议，保证跨网通信兼容 | BGP（互联网唯一标准） |
  
- **按运作方式**  
  基于域内/域间的需求，协议可分为三类：  
  1. 距离向量协议（Distance-Vector）：通过邻居传递“到目的地的距离”来计算路径；  
  2. 路径向量协议（Path-Vector）：距离向量的扩展，除距离外还传递“路径节点”，避免环路（如 BGP）；  
  3. 链路状态协议（Link-State）：每个路由器向全网广播“自身链路状态”，各路由器独立计算全网路径（如 OSPF）。

- 关键补充：互联网是“网络的网络”，无单一全局路由协议，而是通过“域内协议管内部，域间协议管互联”实现跨网通信。

## 二、路由状态

该模块聚焦“路由的具体实现机制”，包括如何转发数据包、如何判断路由是否有效、如何找最优路径、如何手动配置固定路由。

### 1. 基于目的地的转发

这是互联网的核心转发机制——路由器通过“转发表”决策，仅依赖数据包的目的地址：
- **转发表**  
  核心功能：映射“目的地”到“下一跳（或物理端口）”，格式如下（以路由器 R2 为例）：  
  
  | 类型         | 目的地（Destination） | 下一跳（Next Hop） | 物理端口（Port） |
  |--------------|-----------------------|--------------------|------------------|
  | 概念表（便于理解） | A                     | R1                 | -                |
  |              | B                     | R3                 | -                |
  | 实际表（硬件执行） | A                     | -                  | 0                |
  |              | B                     | -                  | 1                |
  |工作流程：数据包到达 R2 → 提取目的地址（如 B）→ 查表格找到下一跳 R3（或端口 1）→ 转发数据包。||||
  
- **转发 vs 路由：核心区别**  
  两者常被混淆，但本质不同，关键差异如下：  
  
  | 维度         | 转发（Forwarding）                | 路由（Routing）                    |
  |--------------|-----------------------------------|-----------------------------------|
  | 范围         | 本地（仅依赖当前路由器的表格）    | 全局（需与其他路由器协调）        |
  | 触发时机     | 每次数据包到达（纳秒级，高频）    | 网络变化时（如链路故障，低频）    |
  | 核心任务     | 按表格转发数据包                  | 生成/更新转发表格                  |

### 2. 路由状态有效性

路由状态是否“有效”，取决于能否保证数据包最终到达目的地，核心是“全局判断”而非“本地判断”：
- **有效性的前提：全局路由状态**  
  单个路由器的转发表无法判断有效性（如仅看 R2 的表，无法确定 R3 是否能转发到 B）。需结合**所有路由器的转发表**（即“全局路由状态”），才能判断数据包的完整路径。

- **有效性的核心条件：无死端 + 无环路**  
  全局路由状态有效，当且仅当满足以下两点：  
  1. 无死端（Dead End）：数据包到达某路由器后，无对应下一跳（除“到达目的地”外），导致数据包无法继续转发；  
     例：R3 的表中“目的地址B”无下一跳，数据包到 R3 后卡住。  
  2. 无环路（Loop）：数据包在一组路由器间循环，永远无法到达目的地（因转发决策仅看目的地址，一旦入环无法逃出）；  
     例：R2→R3→R2→R3，数据包循环。

- **有效性的证明：双向验证**  
  1. 必要条件：若有死端/环路，数据包必到不了目的地（死端直接卡住，环路无限循环）；  
  2. 充分条件：若无死端/环路，数据包必到目的地（路由器数量有限，数据包不会重复访问路由器，最终会到达目的地）。

- **有效性的验证方法：有向交付树**  
  对每个目的地，按转发表画“有向箭头”（路由器→下一跳），形成“有向交付树”，需满足：  
  - 树的根是目的地；  
  - 所有边指向根（数据包向目的地转发）；  
  - 覆盖所有设备（无断开节点）；  
  - 无环路（树结构无 cycles）。  
  例：验证“目的地A”的有效性，需确保所有路由器的箭头最终指向 A，且无环、无断开。

### 3. 最小成本路由

“有效”的路由是基础，“最优”的路由需通过“最小成本”定义——为链路分配成本，找成本最低的路径。
- **成本的定义与来源**  
  成本是“衡量路径优劣的指标”，由运营商根据需求设定，常见指标包括：  
  - 延迟（ propagation delay ）、带宽、距离、价格、可靠性；  
  例：若以“跳数”为成本（每链路成本=1），则“最小成本路径”即“跳数最少的路径”。

- **成本的核心属性**  
  1. 正整数：成本≥1，确保“增加链路不会让路径更便宜”（避免环路，因环路会增加成本）；  
  2. 对称（默认）：A→B 的链路成本 = B→A的成本（如网线的上传/下载延迟相同，理论可不对称，如卫星链路）；  
  3. 本地可知：路由器仅需知道自身直连链路的成本，无需全局成本信息。

- **最小成本路径的优势** 
  最小成本路径必然是“有效路径”：  
  - 因成本为正，不会形成环路（环路会增加成本，不符合“最小”）；  
  - 仍基于目的地转发，形成“有向生成树”，覆盖所有设备。

### 4. 静态路由

路由表的条目可“手动配置”，无需依赖路由协议，分为两类：
- **直连路由（Connected/Direct Routes）**  
  原理：路由器直接连接的设备（如 R1 连 A），无需路由协议，运营商配置路由器时自动生成；  
  特点：仅适用于“直连目的地”，无需计算路径。

- **静态路由（Static Routes）**  
  原理：运营商手动硬编码的路由条目，目的地不一定直连；  
  特点：  
  1. 固定不变：无论网络如何变化，静态路由条目不更新；  
  2. 无需协议：不依赖路由协议发现路径，由人工维护；  
  例：运营商手动配置“R1→目的地址D”的下一跳为 R2，即使 R2-R4 链路故障，R1 仍会转发到 R2（需人工修改）。

- 适用场景：网络拓扑固定、无动态变化的场景（如小型办公室、专用链路）。


## 三、核心总结
本笔记围绕“路由的本质是‘分布式计算最优路径’”展开，核心逻辑链为：  
1. 为何需要路由？→ 解决拓扑扩展性与带宽问题，引入路由器；  
2. 如何建模网络？→ 用“图”抽象设备与链路，用“数据包头部”承载路由信息；  
3. 路由难在哪？→ 拓扑动态、无全局视图、链路丢包；  
4. 如何实现路由？→ 按“域内/域间”选协议，用“目的地转发”决策，用“无死端/无环路”验证有效性，用“最小成本”选最优路径，用“静态路由”适配固定场景。  

这些内容是理解互联网路由机制的基础，后续会深入具体路由协议（如BGP、OSPF）的实现细节。