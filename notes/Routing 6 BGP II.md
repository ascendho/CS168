# Routing 6: BGP II

## 一、BGP Implementation（BGP协议实现）

BGP（边界网关协议）是互联网跨AS路由的核心协议，负责在不同AS之间交换路由信息，确保数据包能从源AS到达目标AS。本部分从“AS内路由器分工”“路由会话类型”“多链路选路”“消息与属性”“协议缺陷”五个维度展开。


### 1. External BGP and Internal BGP（外部BGP与内部BGP）
#### （1）AS内路由器分类
- **边界路由器（Border Routers）**：至少有一条链路连接其他AS，负责与外部AS交换路由信息（如笔记图中AS#1的A、B、G）。  
- **内部路由器（Interior Routers）**：仅连接同一AS内的路由器，不与外部AS直接通信（如AS#1的C、D、E、F）。  
- **BGP发言人（BGP Speakers）**：仅边界路由器能“说BGP”，即理解BGP语法语义，向其他AS宣告路由；**Stub AS（存根AS）** 例外——仅连接一个上游提供商AS，无需BGP，边界路由器可将所有流量默认路由到提供商。

#### （2）三种核心路由会话
BGP通过三种会话实现“AS内协同+AS间通信”，三者分工明确：
| 会话类型 | 通信对象 | 核心用途 | 关键差异 |
|----------|----------|----------|----------|
| eBGP（External BGP） | 不同AS的边界路由器 | 交换跨AS的外部路由（如AS#1的G与AS#5的路由器交换Z的路由） | 宣告路由时会在AS路径前添加本地AS号 |
| iBGP（Internal BGP） | 同一AS的边界路由器（→内部路由器） | 将eBGP学到的外部路由分发给AS内所有路由器 | 路由属性（如ASPATH）不变，仅传递出口路由器信息 |
| IGP（Interior Gateway Protocol） | 同一AS的所有路由器 | 学习AS内的内部路由（如“到G的下一跳是F”） | 基于距离向量/链路状态，仅关注内部可达性 |

#### （3）路由协同流程（AS内如何处理内外路由）
1. **学内部路由**：通过IGP（如OSPF、RIP），所有路由器生成**IGP表**，记录“内部目的地→下一跳”（如D的IGP表：到G的下一跳是E）。  
2. **学外部路由**：边界路由器通过eBGP学习外部路由（如G通过eBGP学到“到Z需经AS#5”）。  
3. **分外部路由**：边界路由器通过iBGP将外部路由分发给AS内所有路由器，生成**BGP表**，记录“外部目的地→出口路由器”（如D的BGP表：到Z的出口是G）。  
4. **查下一跳**：  
   - 内部目的地：直接查IGP表；  
   - 外部目的地：先查BGP表找出口路由器，再查IGP表找“到出口路由器的下一跳”（如到Z：BGP表→出口G，IGP表→到G的下一跳E）。

#### （4）iBGP的实现问题
- **简单方案**：同一AS内所有边界路由器两两建立iBGP会话（N个边界路由器需N×(N-1)/2个会话），但大规模AS中会面临扩展性问题。  
- **优化方案**：引入“路由反射器（Route Reflector）”，作为中心节点转发iBGP路由，减少会话数量（笔记中提及需额外了解）。


### 2. Multiple Links Between ASes（AS间多链路）
当两个AS间存在多条链路时，需通过特定策略选择最优路径，核心目标是“最小化自身资源消耗”。

#### （1）多链路的意义
单链路可能导致数据包走长路径（如AT&T与Verizon单链路时绕路），多链路可提供更短路径，提升传输效率。

#### （2）Hot Potato Routing（热土豆路由）——进口AS的选择
- **核心逻辑**：AS收到外部数据包时，优先选择“最近的出口路由器”，尽快将数据包“扔”给下一个AS，减少自身网络带宽消耗（“尽快脱手，让别人扛剩下的路”）。  
- **例子**：AT&T到Y有两条路径（出口I或F），IGP计算显示“到F的成本更低”，则选择F作为出口，让数据包尽快进入Verizon。

#### （3）Multi-Exit Discriminator（MED）——出口AS的引导
- **核心逻辑**：出口AS（如Verizon）在eBGP宣告路由时，附加MED值（表示“本AS内边界路由器到目标的距离”，数值越低越近），引导进口AS（如AT&T）选择更近的边界路由器，减少出口AS的带宽消耗。  
- **例子**：Verizon的A到Y距离5（MED=5），E到Y距离1（MED=1），AT&T收到后会优先选择E作为入口，Verizon无需承担A到E的长距离传输。

#### （4）MED与Hot Potato的矛盾
- **矛盾点**：进口AS的Hot Potato（选自己最近的出口）与出口AS的MED（希望进口选自己最近的入口）可能冲突，导致**非对称路径**：  
  - X→Y：AT&T选最近出口F（Hot Potato），Verizon承担F到Y的传输；  
  - Y→X：Verizon选最近出口E（Hot Potato），AT&T承担E到X的传输。

#### （5）导入/导出的选路策略优先级
当存在多条候选路由时，AS按以下优先级选择（从高到低）：
1. **Gao-Rexford规则**：优先选择“客户AS→对等AS→提供商AS”的路径，通过`LOCAL PREFERENCE`属性实现（数值越高越优），核心是“省钱”；  
2. **最短AS路径**：选择经过AS数量最少的路径，提升传输性能；  
3. **Hot Potato路由**：选择到出口路由器IGP成本最低的路径，减少自身带宽消耗；  
4. **最低MED**：选择MED值最小的路径，配合出口AS减少其带宽消耗；  
5. **任意破局**：如选择IP地址更小的路由器，无明确技术目标。


### 3. Message Types and Route Attributes（BGP消息类型与路由属性）
BGP通过标准化的消息和属性实现路由交换，确保不同厂商设备兼容。

#### （1）BGP的4种消息类型
| 消息类型 | 核心作用 | 关键细节 |
|----------|----------|----------|
| Open | 启动BGP会话 | 双方交换AS号、路由器ID等基础信息，建立连接 |
| KeepAlive | 维持会话 | 周期性发送（默认30秒），确认对方在线，避免会话超时关闭 |
| Notification | 错误通知 | 检测到错误（如AS号不匹配、路由格式错误）时发送，随后关闭会话 |
| Update | 路由宣告 | 最核心消息，可宣告“新增路由”“更新旧路由”或“撤销无效路由”，包含“目标前缀+路由属性” |

#### （2）核心路由属性（Update消息的关键内容）
路由属性是BGP选路的依据，分为“本地属性”（仅iBGP内传递）和“全局属性”（eBGP/iBGP均传递）：
1. **ASPATH（全局属性）**  
   - 格式：目标前缀对应的AS路径列表（反序，如“到达128.112.0.0/16需经AS3→AS72→AS25”，ASPATH记为[3,72,25]）；  
   - 作用：① 防环（检测到本地AS号在ASPATH中则丢弃路由）；② 选路（AS路径越短越优）。

2. **LOCAL PREFERENCE（本地属性）**  
   - 格式：数值（如1000、3000），仅在iBGP内传递，数值越高越优；  
   - 作用：实现Gao-Rexford规则（如给“客户AS路径”设更高LOCAL PREFERENCE=3000，“对等AS路径”设1000），控制AS内选路优先级。

3. **MED（全局属性）**  
   - 格式：数值（如1、4），eBGP/iBGP均传递，数值越低越优；  
   - 作用：多链路场景下，出口AS引导进口AS选择更近的边界路由器，减少自身带宽消耗。


### 4. Issues with BGP（BGP的问题）
BGP的设计缺陷导致其面临安全、性能和配置风险：
1. **安全风险**：无内置验证机制，AS可能“谎报”路由（如声称自己负责某前缀，或伪造AS路径），导致流量被劫持（如中间人攻击）；  
2. **性能权衡**：基于策略的路径不一定是“最短路径”（如为省钱选择提供商路径，而非直连对等路径）；AS路径长度可能误导（如同一AS内路径可能1跳或100跳，但AS路径长度均记为1）；  
3. **配置复杂**：BGP属性多（如LOCAL PREFERENCE、MED），配置依赖手动操作，易出错（BGP配置错误是互联网大规模中断的主要原因之一）；  
4. **无效路由**：若不遵循Gao-Rexford规则，AS间路由可能出现“不可达”或“收敛缓慢”，无法保证全网连通性。


## 二、IP Header（IP头部）
IP头部是数据包的“控制面板”，需满足“小体积、简单化”设计目标，支持数据包解析、转发、错误处理等核心功能，分为IPv4头部解析和IPv6改进两部分。


### 1. IPv4 Header Fields（IPv4头部字段）
IPv4头部结构如下（关键字段已标注），每个字段对应IP的6大核心任务：

| 字段（比特数） | 核心任务 | 详细说明 |
|----------------|----------|----------|
| Version（4） | 解析数据包 | 标识IP版本（IPv4=4，IPv6=6），确保设备用正确规则解析 |
| Hdr len（4） | 解析数据包 | 头部长度，单位为“4字节”（因头部含可选字段，长度不固定）；计算方式：字段值×4=实际头部字节数（如值=5→20字节，为IPv4最小头部） |
| Type of Service（8） | 特殊处理 | 原设计用于“优先级、延迟、吞吐量”控制，现代仅保留两类功能：① DSCP（区分服务代码点，划分流量类别）；② ECN（显式拥塞通知，参与拥塞控制） |
| Total Length（16） | 解析数据包 | 整个数据包（头部+Payload）的总字节数，最大65535字节（2¹⁶-1），确保设备知道数据包何时结束 |
| Identification（16） | 错误处理（分片） | 同一数据包的所有分片共享相同ID，用于接收方重组 |
| Flags（3） | 错误处理（分片） | 含2个有效位：① DF（Don't Fragment，禁止分片，超MTU则丢弃）；② MF（More Fragments，是否有更多分片，最后一片MF=0） |
| Fragment Offset（13） | 错误处理（分片） | 分片在原Payload中的起始位置，单位为“8字节”；计算方式：字段值×8=实际起始字节（如值=125→1000字节，对应原Payload第1000字节开始） |
| TTL（8） | 错误处理（防环） | 数据包最大跳数（每经一个路由器减1）；TTL=1时丢弃，并向源发送“TTL超时”消息，避免数据包无限循环 |
| Protocol（8） | 告知目的地下一步 | 标识Payload对应的L4协议（如TCP=6，UDP=17），实现“解复用”（接收方知道将Payload交给哪个L4协议处理） |
| Header Checksum（16） | 错误处理（校验） | 仅校验IP头部（不校验Payload，遵循端到端原则，由L4/L7校验Payload）；路由器修改TTL后需重算校验和，校验失败则丢弃数据包 |
| Source IP（32） | 回传响应 | 标识数据包来源，用于接收方/路由器发送响应（如错误消息、回复数据） |
| Destination IP（32） | 转发数据包 | 标识数据包目标，路由器通过该字段查路由表确定下一跳 |
| Options（可变） | 特殊处理 | 可选扩展字段（如Record Route记录路径、Source Route指定路由），但会增加路由器处理开销，现代互联网极少使用 |
| Payload | 数据传输 | 实际数据（如TCP/UDP段、应用层数据） |

#### 关键任务与字段对应总结
1. **解析数据包**：Version（版本）、Hdr len（头部边界）、Total Length（数据包边界）；  
2. **转发数据包**：Destination IP（目标地址查路由表）；  
3. **告知目的地下一步**：Protocol（交给哪个L4协议）；  
4. **回传响应**：Source IP（响应的目标地址）；  
5. **错误处理**：TTL（防环）、Checksum（头部校验）、ID/Flags/Offset（分片重组）；  
6. **特殊处理**：Type of Service（流量类别）、Options（扩展功能）。


### 2. IPv6 Changes（IPv6的改进）
IPv6的核心动机是解决IPv4地址耗尽（32位→128位，地址空间极大），同时“清理”IPv4的冗余设计，简化路由器工作。

#### （1）四大核心改进（“清理”措施）
| 改进点 | IPv4问题 | IPv6解决方案 | 核心收益 |
|--------|----------|--------------|----------|
| 取消校验和 | 路由器需频繁重算（因TTL变化），增加开销 | 移除IP头部校验和，Payload由L4/L7校验 | 路由器处理速度提升 |
| 取消分片 | 路由器需分片/重组，开销大 | 路由器不分片：超MTU则丢弃，向源发送“MTU过大”错误，由源端负责分片 | 路由器无需处理分片，效率提升 |
| 取消选项 | 头部长度可变，路由器需解析选项，开销大 | 头部固定长度（40字节），扩展功能由“Next Header”字段实现 | 路由器无需处理可变选项，简化逻辑 |
| 增加Flow Label（20位） | 无字段标记“相关数据包”，中间设备（如防火墙）难处理流 | 同一流的数据包标记相同Flow Label，中间设备可批量处理 | 支持流级别的QoS和安全控制，适配现代网络需求 |

#### （2）字段重命名与结构变化
- **重命名字段**：Type of Service→Traffic Class（功能不变）、Total Length→Payload Length（仅表示Payload长度，头部长度固定40字节）、TTL→Hop Limit（功能不变）；  
- **地址长度**：Source/Destination IP从32位扩展到128位，彻底解决地址耗尽问题；  
- **Next Header字段**：替代IPv4的Options和Protocol，可链式传递（如IPv6 Header→扩展头1→扩展头2→TCP Header），支持灵活扩展，且不增加头部长度。

#### （3）IPv6设计哲学
- **端到端原则**：将复杂逻辑（如分片、校验）交给端主机，路由器仅负责“快速转发”；  
- **简化路由器工作**：固定头部、取消冗余字段，最大化路由器吞吐量；  
- **未来可扩展**：Next Header和Flow Label支持新功能（如新型扩展头、流处理），无需修改核心协议。


### 3. IP Security（IP安全问题）
IP头部设计缺乏安全机制，攻击者可利用各字段发起攻击，具体如下：

| 头部字段 | 攻击方式 | 危害 | 防御思路 |
|----------|----------|------|----------|
| Source IP | 地址欺骗（伪造源IP） | 1. DoS攻击：目标无法识别攻击源，无法拉黑；2. 嫁祸：伪造他人IP发送恶意数据，导致他人被追责 | 入口过滤（路由器检查源IP是否属于本地网段）、BGP路由验证（如ROA） |
| Type of Service | 伪造优先级 | 攻击者将自身流量设为高优先级，抢占网络资源；或伪造他人IP发送高优先级流量，导致他人承担高额费用 | 路由器过滤非授权的优先级设置，仅信任特定设备的ToS字段 |
| Fragmentation/Options | DoS攻击 | 发送超大数据包（强制路由器分片）或含复杂选项的数据包，耗尽路由器CPU/内存资源 | 路由器限制分片大小，或直接丢弃含Options的数据包 |
| TTL | Traceroute探测 | 利用“TTL过期发超时消息”的机制，发送TTL=1,2,...的数据包，探测目标网络拓扑，为后续攻击做准备 | 路由器禁止向外部发送“TTL超时”消息，或限制Traceroute响应频率 |
| Protocol/Checksum | 无有效攻击 | Protocol错误导致Payload无法解析，Checksum错误导致数据包被丢弃，无法造成实质危害 | 无需额外防御 |


## 三、整体总结
本笔记围绕“跨AS路由（BGP）”和“数据包控制（IP头部）”两大网络核心组件展开，体现了网络协议设计的关键权衡：
1. **BGP**：通过eBGP/iBGP/IGP协同实现AS间路由，以“基于策略的选路”为核心，兼顾商业需求（如Gao-Rexford规则省钱）和技术效率（如热土豆、MED减少资源消耗），但面临安全和配置复杂性问题；  
2. **IP头部**：IPv4以“多功能”为目标，支持解析、转发、错误处理等，但存在冗余字段（如校验和、选项）；IPv6以“简化路由器、适配未来”为目标，清理冗余并扩展地址空间，体现了网络协议从“功能优先”到“效率与可扩展性优先”的演进。