

### Routing 5: BGP I

#### 一、自治系统（Autonomous Systems, AS）：域间路由的基本单元

1. **定义与标识**  
   
   - 自治系统（AS）是**由单一管理实体控制的一个或多个本地网络**，例如UC Berkeley的AS包含CalVisitor和eduroam网络，有时也称为“域”。  
   - 每个AS分配唯一的**AS号（ASN）**，由**IANA（互联网编号分配机构）** 管理（早期由个人分配，如Jon Postel）。  
   - 示例：UC Berkeley的ASN为25，全球当前AS数量超**90,000个**。
   
2. **AS的核心类型**  
   两种核心类型，对应不同功能定位，具体区别如下表：
   | AS类型       | 核心功能                                  | 是否转发其他AS流量 | 示例                | 占比   |
   |--------------|-------------------------------------------|--------------------|---------------------|--------|
   | **Stub AS**  | 仅为内部主机收发数据包                    | 否                 | UC Berkeley、本地银行 | 多数   |
   | **Transit AS** | 为内部主机服务，同时转发其他AS流量        | 是                 | AT&T、Verizon        | 少数   |
   *注：Google、Amazon等现代AS模糊两类边界，课程暂不讨论。*

3. **AS图与历史特性**  
   - **AS图**：抽象域间拓扑，节点为AS，边反映物理连接与商业关系，隐藏内部路由器/主机。  
   - 历史趋势：AS数量持续增长，1985年极少，2025年超90,000个；地域分布上，**美国AS数量最多**，其次为巴西。  
   - **Tier 1 AS**：位于AS层级顶端，共约**20个**，无提供商（无 incoming 客户-提供商边），与所有其他Tier 1 AS为对等关系，保证AS图连通性（如美国AT&T、欧洲Telecom Italia、亚洲NTT Communications）。


#### 二、AS间商业关系：塑造域间拓扑的核心
1. **两种核心商业关系**  
   商业关系决定AS间的流量转发规则，是域间路由策略的基础：
   - **客户-提供商关系**：客户向提供商付费，提供商为客户转发往返流量；在AS图中用“提供商→客户”的箭头表示，体现“服务向下、资金向上”的层级。  
   - **对等关系**：双方无付费，仅交换“大致对等”的流量；AS图中用双向箭头表示，仅用于直接交换自身流量，不提供第三方转发。

2. **AS图的关键特性**  
   - **无环性**：客户-提供商关系无循环（否则会出现“自付费”的不合理情况）；对等关系可形成循环，但不影响层级。  
   - **层级性**：所有非Tier 1 AS至少有1个提供商，从任意AS沿“客户→提供商”方向向上，最终可到达Tier 1 AS，保证全局连通。


#### 三、域间路由的核心目标：兼顾技术与商业需求
域间路由需同时满足技术可行性与商业自主性，核心目标包括：
1. **可扩展性**：支持互联网级规模（超90,000个AS），解决方案是**层级IP地址**，通过地址聚合减少路由表条目。  
2. **隐私性**：AS无需向外界暴露敏感信息（如具体提供商、内部拓扑），避免商业竞争劣势（仅少量信息不可避免泄露）。  
3. **自主性**：AS可自由制定路由策略（基于商业目标），即**策略路由**——这是域间路由与域内路由（仅追求最短路径）的核心区别。  

   - 策略路由示例：拒绝转发AS#2046的流量、优先选择AS#10而非AS#4转发自身流量、工作日用AS#12周末用AS#13。  
   - 策略路由要求：最终路径必须满足所有途经AS的策略，而非仅“最短路径”。


#### 四、Gao-Rexford规则：标准化策略路由
为避免任意策略导致的路由混乱，多数AS遵循**Gao-Rexford规则**（基于真实商业实践：盈利优先、不免费工作），核心包括三部分：

1. **路由选择规则**：优先选择“最盈利”的路径  
   路径优先级排序：**客户路径（Next Hop为客户，盈利）> 对等路径（Next Hop为对等，无盈利）> 提供商路径（Next Hop为提供商，付费，最差）**。  
   - 示例：若AS S收到A（提供商）、B（对等）、C（客户）均能到达D的路由，S会优先选择C的路径，因C需向S付费。

2. **路由参与规则**：仅参与“盈利”的路由  
   AS同意转发某条路径的前提：**路径中至少有一个邻居是自身客户**（确保“有收入覆盖成本”），具体场景如下表：
   | 场景（路径：A→B→C） | B的邻居关系       | 是否参与 | 原因                     |
   |----------------------|--------------------|----------|--------------------------|
   | 场景1                | A（客户）、C（客户） | ✅        | 双端客户，盈利最高       |
   | 场景2                | A（对等）、C（客户） | ✅        | C为客户，有盈利          |
   | 场景3                | A（提供商）、C（客户）| ✅        | C为客户，盈利覆盖A的成本 |
   | 场景4                | A（对等）、C（对等） | ❌        | 无客户，免费工作         |
   | 场景5                | A（提供商）、C（对等）| ❌        | 无客户，需付费给A        |

3. **路由导出规则**：仅广告“盈利”的路由  
   AS导出（广告）路由的范围由路由来源决定，确保不承担无收益的转发责任，具体规则如下表：
   | 路由来源       | 导出对象（邻居类型）       | 核心逻辑                     |
   |----------------|----------------------------|------------------------------|
   | 客户           | 所有人（提供商、对等、客户） | 客户已付费，广告给所有人可扩大盈利 |
   | 对等           | 仅客户                     | 对等无付费，仅为客户提供服务   |
   | 提供商         | 仅客户                     | 需向提供商付费，仅通过客户盈利 |

4. **规则的核心价值**  
   若所有AS遵循Gao-Rexford规则，可保证两个关键特性：  
   - **可达性**：任意两个AS间存在至少一条满足所有策略的路径；  
   - **收敛性**：所有AS最终会对路径达成共识（稳态下无路由震荡）。


#### 五、BGP协议：实现域间路由的唯一标准
**BGP（Border Gateway Protocol）** 是当前互联网唯一的域间路由协议，基于距离向量协议扩展，适配策略路由需求。

1. **BGP的历史背景**  
   - 发展历程：1989-1995年“按需设计”，无先例参考（域间路由的“商业策略”是计算机网络新问题）；  
   - 地位：虽非完美，但已稳定运行数十年，是所有AS公认的统一协议（域间路由需全局统一协议）。

2. **BGP与传统距离向量协议的关键区别**  
   传统距离向量协议（如RIP）以“最短路径”为核心，BGP则以“策略”为核心，关键改进包括：
   | 对比维度       | 传统距离向量协议       | BGP协议                 |
   |----------------|------------------------|-------------------------|
   | 路由选择依据   | 最短路径（距离最小）   | 策略（如Gao-Rexford规则）|
   | 路由导出范围   | 所有邻居               | 仅盈利路由（按来源筛选） |
   | 路由信息内容   | 距离（跳数）           | 完整AS路径（路径向量）   |
   | 路由表优化     | 无聚合（默认）         | 支持前缀聚合           |

3. **BGP的核心机制**  
   - **导入（Import）**：从邻居广告的路由中，按策略选择“最优路由”（如Gao-Rexford的客户>对等>提供商），决定自身 outbound 流量的转发方向。  
   - **导出（Export）**：按Gao-Rexford导出策略，向特定邻居广告最优路由，决定自身将承载哪些邻居的流量。  
   - **前缀聚合（Aggregation）**：将多个连续的IP前缀合并为一个更大的前缀（如将12.1.0.0/16、12.2.0.0/16合并为12.0.0.0/8），大幅减少路由表条目，提升可扩展性；仅受“多归属”（AS有多个提供商）轻微限制。  
   - **路径向量（Path-Vector）**：广告路由时携带“完整AS路径”（如“A→B→C→D”），解决两大问题：  
     1. **环路检测**：若AS发现路径中已包含自身ASN，直接拒绝该路由；  
     2. **任意策略支持**：AS可检查路径中是否包含需规避的AS（如策略“不经过AS#2019”）。

4. **Stub AS的简化方案**  
   若Stub AS仅连接1个提供商，无需运行完整BGP：通过**默认路由**将所有outbound流量转发给提供商，提供商代为向其他AS广告该Stub AS的前缀。


---

### 4. 关键问题
#### 问题1：自治系统（AS）的核心分类及功能区别是什么？这对域间路由有何影响？
**答案**：AS核心分为**Stub AS**和**Transit AS**，区别及对域间路由的影响如下：  
- 分类区别：  
  - Stub AS：仅为内部主机收发数据包，**不转发其他AS的流量**（如UC Berkeley、本地银行），占全球AS的多数；  
  - Transit AS：既为内部主机服务，**也转发其他AS的流量**（如AT&T、Verizon），数量较少，多为运营商。  
- 对域间路由的影响：  
  - 路由策略差异：Stub AS仅需关注自身与提供商/对等AS的路由，无需处理第三方转发；Transit AS需制定复杂策略，平衡盈利（客户流量）与成本（转发其他AS流量）；  
  - AS图结构：Stub AS作为“叶子节点”（无 outgoing 客户-提供商边），Transit AS作为“中间节点”（有 outgoing 边），共同构成无环层级的AS图，保证域间路由的可扩展性。


#### 问题2：Gao-Rexford规则的核心逻辑是什么？它如何解决域间路由中“商业需求”与“技术可行性”的矛盾？
**答案**：Gao-Rexford规则的核心逻辑是**“盈利优先、不免费工作”**，基于真实商业实践设计，通过三方面解决矛盾：  
1. 核心逻辑体现：  
   - 路由选择：优先客户路径（盈利）> 对等路径（无盈利）> 提供商路径（付费）；  
   - 路由参与：仅转发“至少有一个邻居是客户”的路径，避免免费为第三方服务；  
   - 路由导出：按路由来源限制广告范围（客户来源广告给所有人，对等/提供商来源仅广告给客户），控制成本。  
2. 矛盾解决：  
   - 商业需求：允许AS以“盈利”为核心制定策略，符合企业商业目标（如Transit AS通过转发客户流量赚钱）；  
   - 技术可行性：标准化的策略避免“任意策略导致的路由混乱”，保证域间路由的**可达性**（任意AS可通信）和**收敛性**（所有AS共识路径），实现技术上的稳定运行。


#### 问题3：BGP协议相较于传统距离向量协议，在域间路由场景下做了哪些关键改进？这些改进解决了什么问题？
**答案**：BGP基于距离向量协议扩展，针对域间路由的“策略需求”和“规模需求”做了4项关键改进，解决的问题如下：  
1. **路由选择依据：从“最短路径”改为“策略优先”**  
   - 解决问题：传统距离向量仅追求跳数最少，无法满足AS的商业策略（如拒绝转发特定AS流量、优先选择客户路径）；BGP可按Gao-Rexford等策略选择路由，适配商业需求。  
2. **路由导出范围：从“广告给所有邻居”改为“仅广告盈利路由”**  
   - 解决问题：传统距离向量会向所有邻居广告路由，导致AS承担无收益的转发成本；BGP仅广告“能盈利”的路由（如客户来源广告给所有人，对等/提供商来源仅广告给客户），控制运营成本。  
3. **路由信息：从“仅携带距离”改为“携带完整AS路径（路径向量）”**  
   - 解决问题：传统距离向量仅知“距离”，无法检测环路（域间路由无最短路径保证），也无法支持“规避特定AS”的策略；BGP的完整路径可快速检测环路（发现自身ASN则拒绝），并支持任意策略检查。  
4. **支持前缀聚合**  
   - 解决问题：互联网超90,000个AS，传统距离向量不聚合会导致路由表爆炸；BGP将多个连续IP前缀合并为大前缀（如12.1.0.0/16+12.2.0.0/16→12.0.0.0/8），大幅减少路由表条目，满足规模需求。