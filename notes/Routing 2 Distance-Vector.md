# Routing 2: Distance-Vector

## 一、算法核心概述
距离向量协议是一种分布式路由协议，本质是**异步版的Bellman-Ford最短路径算法**，核心思想可概括为：“听到目标路径后，告知所有邻居”。

### 核心特性
- 分布式：无全局控制节点，每个路由器独立维护路由表并执行更新逻辑。
- 异步：路由器无需同步执行更新操作，自主完成路径计算。
- 多目标扩展：对每个目标独立运行路径传播算法，通过路由表记录各目标的下一跳和成本。
- 路由与转发分离：路由信息（“可达目标”）从目标向外传播，数据包转发时从边缘向目标收敛。

## 二、正确性核心规则（基础运行逻辑）
### Rule 1：Bellman-Ford更新规则
- 核心目的：选择最优路径（最低成本）。
- 触发条件：收到邻居路径通告时，满足以下任一情况则更新路由表：
  1. 路由表中无该目标的记录；
  2. 邻居通告的成本 + 本地到邻居的链路成本 < 当前已知最优成本。
- 关键细节：链路成本未必均等，需通过“本地链路成本+邻居通告成本”计算实际路径成本。
- 本质：实现最短路径算法中的“松弛操作”，确保逐步收敛到最优路径。

### Rule 2：下一跳更新规则
- 核心目的：应对拓扑变化，及时接收下一跳的状态通知。
- 触发条件：即使邻居通告的路径成本更高，只要该邻居是当前目标的下一跳，就接受更新。
- 逻辑依据：下一跳的路径状态变化（如链路故障）需优先同步，避免因忽略差路径导致路由失效。

### Rule 3：重发规则
- 核心目的：确保路由信息可靠传输（应对数据包丢失）。
- 操作逻辑：路由表更新时主动向所有邻居通告新路径；同时定期（按“通告间隔”）重发路由信息。
- 可靠性保障：只要链路有非零传输成功率，路由信息最终会被邻居接收。

### Rule 4：过期规则
- 核心目的：处理链路/路由器故障，清理失效路由。
- 操作逻辑：
  1. 每条路由表项关联一个“生存时间（TTL）”；
  2. 收到邻居通告时，重置该路由的TTL；
  3. 若TTL到期未收到更新，删除该路由表项。
- 关键作用：避免因故障导致的“无效路由长期存在”问题。

## 三、协议增强规则（优化收敛与防环）
### Rule 5：毒化过期路由（Poison Expired Routes）
- 核心问题：仅依赖TTL过期清理路由速度慢，期间可能丢失数据包或误判路径。
- 优化逻辑：
  1. 路由过期或本地检测到故障时，将该路由成本设为“无穷大（∞）”，即“毒化路由”；
  2. 主动向邻居通告毒化路由，触发邻居快速清理无效路径。
- 优势：比TTL过期更快收敛，减少故障期间的数据包丢失。

### Rule 6A：水平分割（Split Horizon）
- 核心问题：避免“路由回传”导致的2节点环路（如A→B的路径，B再通告给A）。
- 优化逻辑：从某邻居获得的路由，不再反向通告给该邻居。
- 示例：路由器B通过A学到目标C的路径，则B不会向A通告该路径，避免环路。

### Rule 6B：反向毒化（Poison Reverse）
- 核心目的：增强防环效果，比水平分割更主动。
- 优化逻辑：从某邻居获得的路由，反向向该邻居通告“毒化路由（成本∞）”。
- 优势：
  1. 明确告知邻居“不要通过我转发该目标的数据包”；
  2. 即使已形成环路，也能快速通过毒化路由打破。

### Rule 7：计数到无穷（Count To Infinity）
- 核心问题：水平分割/反向毒化无法解决3节点及以上的长环路（如A→B→C→A）。
- 优化逻辑：
  1. 设定最大成本阈值（常用16），成本≥16的路由视为“无穷大（不可达）”；
  2. 环路中路由的成本会逐步递增，达到阈值后被标记为毒化路由，环路自动终止。
- 作用：限制环路持续时间，避免路由成本无限增长。

## 四、事件驱动更新（Eventful Updates）
### 触发场景
- 主动触发：路由表更新（如新路径发现、路径成本变化）、链路新增/故障、路由毒化时；
- 被动触发：按“通告间隔”定期重发、路由TTL过期时。
- 核心价值：触发式更新无需等待定期间隔，加速网络收敛。

## 五、完整算法流程总结
对每个目标节点，路由器执行以下操作：
1. 接收邻居通告后，满足以下任一条件则更新路由表并重置TTL：
   - 无该目标路由；
   - 通告成本+链路成本 < 已知最优成本；
   - 通告来自当前下一跳（含毒化路由）。
2. 路由表更新时，向所有邻居通告（排除水平分割的邻居，或对其发送反向毒化）；
3. 定期重发所有有效路由信息；
4. 路由TTL过期时，毒化该路由并通告邻居，随后删除表项；
5. 成本≥16的路由统一按“无穷大”通告，终止长环路。

## 六、核心术语与关键结论
### 关键术语
- 路由收敛：网络中所有路由器的路由表达到一致最优状态，无环路且路径成本最低；
- 松弛操作：Bellman-Ford算法的核心，通过比较更新路径成本，逐步逼近最短路径；
- 毒化路由：成本设为∞的路由，用于明确标识不可达路径；
- TTL：路由表项的生存时间，用于检测失效路由。

### 核心结论
1. 距离向量协议通过“基础规则保障正确性+增强规则优化性能”，实现分布式路由计算；
2. 防环核心逻辑：水平分割/反向毒化解决短环路，计数到无穷解决长环路；
3. 收敛优化关键：毒化路由+事件驱动更新，减少故障和拓扑变化后的收敛时间；
4. 本质是“分布式Bellman-Ford算法”，无需全局拓扑信息，适合中小型网络。
