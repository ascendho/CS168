# Routing 4: Routers

## 一、真实路由器（Routers in Real Life）
### 1. 部署环境与本质
- 路由器多部署在**托管机房（Colocation Facility）**，也称运营商酒店，可实现网络间高性能互联。
- 本质是**专门用于数据包转发的专用计算机**，而非通用设备。

### 2. 路由器尺寸衡量维度
- 核心维度：物理大小、端口数量、带宽、**容量（Capacity）**。
- 容量计算公式：容量 = 端口数量 × 单个端口线速（Line Rate）。
- 示例：家用路由器（4个100Mbps端口+1个1Gbps端口），总容量=1.4Gbps。

### 3. 现代路由器容量与发展趋势
- 现代路由器：288个端口，单端口线速400Gbps，总容量115.2Tbps；下一代路由器单端口线速800Gbps，总容量230Tbps。
- 发展瓶颈：物理空间、功耗、散热等限制，无法无限增加端口，创新聚焦于**提升单端口线速**（演进路径：10G→100G→400G→800G）。

## 二、路由器组件与平面（Router Components / Planes）
### 1. 三大核心平面（功能分工+时间尺度）
| 平面         | 核心功能                                                                 | 时间尺度       | 关键特点                                   |
|--------------|--------------------------------------------------------------------------|----------------|--------------------------------------------|
| 数据平面     | 处理数据包转发，是路由器核心转发功能载体                                 | 纳秒级（ns）   | 本地运行，不与其他路由器协同，依赖硬件加速 |
| 控制平面     | 运行路由协议、更新转发表项、处理异常数据包                               | 秒级（s）      | 响应网络拓扑变化，向线路卡下发路由规则     |
| 管理平面     | 操作员通过网络管理系统（NMS）配置路由器、监控运行状态（如链路流量、链路成本分配） | 秒/分钟级      | 负责路由器的人工交互与运维监控             |

### 2. 硬件组成结构
- **机架（Chassis）**：金属外壳，用于承载所有硬件组件。
- **控制卡（Controller Card）**：含控制处理器（x86架构），运行路由协议、管理平面功能，与线路卡通信。
- **线路卡（Linecard）**：可插拔设计（1-20个/机架），灵活性强，每个线路卡含多个双向端口、本地CPU、转发芯片、交换矩阵芯片。
- **交换矩阵（Fabric）**：高带宽、容错的互联线路集合，实现不同线路卡间的数据包传输。

## 三、数据包类型（Packet Types）
路由器接收的三类数据包及处理逻辑：
### 1. 用户数据包（User Packet）
- 最常见类型，需按转发表转发至目的地。
- 处理路径：转发芯片查询端口→同线路卡直接转发→异线路卡通过交换矩阵转发（硬件快速路径）。

### 2. 控制平面流量（Control Plane Traffic）
- 目的地为路由器本身，用于路由协议通信（如路由通告）。
- 处理路径：转发芯片将数据包转发至控制卡，由控制处理器处理。

### 3.  punt流量（Punt Traffic）
- 属于用户数据包，但需额外处理（如TTL过期需返回错误消息）。
- 处理路径：转发芯片将数据包“移交”给控制卡，走软件慢路径处理。

## 四、硬件转发（Forwarding in Hardware）
### 1. 转发流水线（三步流程，全硬件实现）
1. **接收数据包**：PHY层解码光/电信号为二进制，MAC层执行链路层操作。
2. **处理数据包**：解析包头（识别IPv4/IPv6）→ 转发表查找下一跳→ 更新数据包（递减TTL、更新校验和、分片等）。
3. **转发数据包**：交换矩阵芯片通过机架间链路将数据包发送至目标线路卡。

### 2. 排队机制（基础实现）
- 分类：默认不分类（复杂场景可按端口/流分类）。
- 缓冲管理：尾部丢弃（队列满时丢弃新数据包）。
- 调度：先进先出（FIFO），按到达顺序转发。

### 3. 硬件转发的核心挑战与权衡
- 核心需求：速度（单端口需每秒处理数百万至数十亿数据包，延迟需控制在纳秒级）。
- 硬件vs软件：硬件（转发芯片、网络处理器）速度快但功能固定；软件灵活但速度慢。
- 操作难度差异：解析（易）、简单动作（更新校验和/TTL，易）、复杂动作（分片/特殊选项，难，需punt至软件）、查找（下一跳查找，核心难点）。

## 五、前缀树高效转发（Efficient Forwarding with Tries）
### 1. 转发查找的核心问题
- 转发表是键值对映射，键为地址范围（可能重叠），需实现**最长前缀匹配**（优先匹配最具体的长前缀）。
- 朴素方案缺陷：直接罗列地址范围会导致表项庞大，更新繁琐。

### 2. 前缀树（Trie）的核心原理
- 结构：按IP地址二进制位逐层构建节点，根节点到标注节点的路径对应有效前缀，标注节点存储下一跳信息。
- 匹配流程：从根节点开始，按IP地址二进制位逐位遍历，记录路径上最近的有效标注节点，遍历结束后返回该节点对应的下一跳（最长前缀）。

### 3. 关键特性与优势
- 时间复杂度：**O(1)常数时间**，IPv4地址仅需遍历32个节点，与转发表大小无关。
- 特殊场景支持：
  - 前缀重叠：非叶节点可作为有效前缀（如短前缀包含长前缀时，短前缀节点为非叶但有效）。
  - 无重叠前缀：有效前缀均对应叶节点。
  - 默认路由：未匹配到任何前缀时，返回默认路由对应的下一跳。

### 4. 优化方向
- 针对热门目的地、端口分布、常见前缀长度（如/24）优化查找速度。
- 兼顾转发表/前缀树的快速更新需求。

## 六、核心总结
1. 路由器通过**三大平面**实现功能分工：数据平面（硬件快速转发）、控制平面（路由协议+异常处理）、管理平面（配置+监控）。
2. 硬件与软件的权衡是数据平面设计核心：硬件负责高速转发（快路径），软件处理灵活需求（慢路径）。
3. 最长前缀匹配是转发关键难点，**前缀树（Trie）** 是核心解决方案，保证查找效率为常数时间。
4. 路由器发展受物理限制，未来聚焦于提升端口线速与转发优化，而非单纯增加端口数量。
